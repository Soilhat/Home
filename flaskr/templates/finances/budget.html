{% extends 'base.html' %}
{% from "components/table.html" import render_table with context %}

{% block header %}
{% block title %}Expenses{% endblock %}
{% endblock %}

{% macro need_real_higher_than_budget(cell, row) -%}
    {% if cell <= row["budget"]%}
        {{cell}}
    {% else %}
        <div class="text-danger">{{cell}}</div>
    {% endif %}
{%- endmacro%}

{% block content %}

<h2 class="h4">
    <input type="month" value="{{month}}" class="form-control bg-light border-0" style="font-size: inherit;width: inherit;" onchange="changeMonth()" id="monthPicker">
</h2>

<div class="row">
<div class="col-xl-6">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Revenus</h6>
        </div>
        {{render_table(revenus, [{"name" :"Label"}, {"name" :"Date"}, {"name" :"Real"}, {"name" :"Budget"}])}}
    </div>
    <div class="card shadow mb-4">
        <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Budget Summary</h6>
        </div>
        {{render_table(summary, [{"name" :"Type"}, {"name" :"%"}, {"name" :"Budget"}, {"name" :"Real", "compare":2}])}}
    </div>
    <div class="card shadow mb-4">
        <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Variables</h6>
        </div>
        {{render_table(variables, [{"name" :"Label"}, {"name" :"Budget"}, {"name" :"Real", "compare":1}, {"name":"Remaining"},{"name" :"Type"}])}}
    </div>
    <div class="card shadow mb-4">
        <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Fixed</h6>
        </div>
        {{render_table(fixed, [{"name" :"Label"}, {"name": "Date"}, {"name" :"Budget"}, {"name" :"Real", "compare":2}, {"name" :"Type"}])}}
    </div>
</div>

<div class="col-xl-6">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Expenses</h6>
        </div>
        {{render_table(
            expenses,
            [
                {"name":"id", "type":"hide"},
                {"name" :"Label"},
                {"name" :"Bank"},
                {"name" :"Date"},
                {"name" :"Amount"},
                {
                    "name" :"Budget",
                    "type": "select",
                    "options": spendings,
                    "onchange":"'update_budget($id)'",
                    "index":"id"
                }
            ]
        )}}
    </div>
</div>
</div>
<script>
  function changeMonth() {
    var input = document.getElementById('monthPicker');
    var url = new URL(window.location.toString())
    var search_params = url.searchParams;
    search_params.set('month', input.value);

    // change the search property of the main url
    url.search = search_params.toString();

    // the new url string
    window.location = url.toString()
  }
  function update_budget(index) {
    var e = document.getElementById(index);
    console.log(e.options[e.selectedIndex].text)
    value = e.options[e.selectedIndex].text
    header = {
        'Content-type':'application/json', 
        'Accept':'application/json'
    }
    fetch("/transac/"+index, {
      method: "POST",
      headers:header,
      body: JSON.stringify(value)
    })
  }
</script>
{% endblock %}